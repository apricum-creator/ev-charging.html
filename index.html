<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>‚ö° EV Charging</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRVYgQ2hhcmdpbmciLCJzaG9ydF9uYW1lIjoiRVYiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjNjY3ZWVhIiwidGhlbWVfY29sb3IiOiIjNjY3ZWVhIn0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            overflow-x: hidden;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding-top: 20px;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            background: #f8f9ff;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .input-suffix {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 16px;
            pointer-events: none;
        }
        
        .slider-container {
            margin: 20px 0;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #667eea 0%, #764ba2 100%);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: none;
        }
        
        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .quick-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quick-btn:active {
            transform: scale(0.95);
            background: #667eea;
            color: white;
        }
        
        .result-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-top: 20px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .result-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .result-value.large {
            font-size: 32px;
        }
        
        .tariff-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tariff-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tariff-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .main-button {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .main-button:active {
            transform: translateY(2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .main-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .info-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            font-size: 12px;
            font-weight: 600;
        }
        
        .battery-visual {
            width: 100%;
            height: 60px;
            border: 3px solid #667eea;
            border-radius: 10px;
            position: relative;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .battery-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }
        
        .battery-terminal {
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 30px;
            background: #667eea;
            border-radius: 0 5px 5px 0;
        }
        
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                bottom: 80px;
                opacity: 0;
            }
            to {
                bottom: 100px;
                opacity: 1;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .nav-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #f8f9ff;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .history-item {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .history-details {
            font-size: 13px;
            color: #666;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Toast notifikace -->
    <div class="toast" id="toast"></div>
    
    <!-- Screen 1: Kalkulaƒçka -->
    <div class="screen active" id="screen-calc">
        <div class="header">
            <h1>‚ö° EV Charging</h1>
            <p class="subtitle">MG ZS EV 2020</p>
        </div>
        
        <div class="card">
            <div class="card-title">
                üîã Aktu√°ln√≠ stav baterie
                <span class="info-badge" id="sohBadge">SoH: --</span>
            </div>
            
            <div class="battery-visual">
                <div class="battery-fill" id="batteryFill" style="width: 35%">35%</div>
                <div class="battery-terminal"></div>
            </div>
            
            <div class="slider-container">
                <input type="range" id="currentSlider" min="0" max="100" value="35" step="1">
            </div>
            
            <div class="input-group">
                <label class="input-label">Nebo zadej zb√Ωvaj√≠c√≠ km</label>
                <div class="input-wrapper">
                    <input type="number" id="kmInput" placeholder="0" min="0">
                    <span class="input-suffix">km</span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">üéØ C√≠lov√Ω stav</div>
            
            <div class="input-group">
                <div class="input-wrapper">
                    <input type="number" id="targetInput" value="80" min="0" max="100">
                    <span class="input-suffix">%</span>
                </div>
            </div>
            
            <div class="quick-buttons">
                <button class="quick-btn" onclick="setTarget(60)">60%</button>
                <button class="quick-btn" onclick="setTarget(80)">80%</button>
                <button class="quick-btn" onclick="setTarget(100)">100%</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">üí∞ Tarif</div>
            <div class="tariff-toggle">
                <button class="tariff-btn active" id="tarifNT" onclick="selectTariff('NT')">
                    üåô N√≠zk√Ω<br><span style="font-size:12px" id="priceNT">-- Kƒç</span>
                </button>
                <button class="tariff-btn" id="tarifVT" onclick="selectTariff('VT')">
                    ‚òÄÔ∏è Vysok√Ω<br><span style="font-size:12px" id="priceVT">-- Kƒç</span>
                </button>
            </div>
        </div>
        
        <div class="card result-box" id="results" style="display: none;">
            <div class="result-item">
                <span class="result-label">Pot≈ôebuje≈° dob√≠t</span>
                <span class="result-value large" id="kwhResult">-- kWh</span>
            </div>
            <div class="result-item">
                <span class="result-label">Cena</span>
                <span class="result-value" id="priceResult">-- Kƒç</span>
            </div>
            <div class="result-item">
                <span class="result-label">Dojezd po nabit√≠</span>
                <span class="result-value" id="rangeResult">-- km</span>
            </div>
        </div>
        
        <button class="main-button" onclick="calculate()">üîÑ Vypoƒç√≠tat</button>
        <button class="main-button" onclick="saveToHistory()" id="saveBtn" style="display: none; margin-top: 10px;">üíæ Ulo≈æit do historie</button>
    </div>
    
    <!-- Screen 2: Historie -->
    <div class="screen" id="screen-history">
        <div class="header">
            <h1>üìä Historie</h1>
            <p class="subtitle">Tvoje nab√≠jen√≠</p>
        </div>
        
        <div class="card">
            <div class="loading" id="historyLoading">
                <div class="spinner"></div>
                <p style="margin-top: 10px; color: #666;">Naƒç√≠t√°m historii...</p>
            </div>
            <div id="historyList"></div>
        </div>
    </div>
    
    <!-- Screen 3: Nastaven√≠ -->
    <div class="screen" id="screen-settings">
        <div class="header">
            <h1>‚öôÔ∏è Nastaven√≠</h1>
            <p class="subtitle">Parametry vozidla</p>
        </div>
        
        <div class="card">
            <div class="card-title">üîã Baterie</div>
            <div class="settings-item">
                <span>Nomin√°ln√≠ kapacita</span>
                <strong id="nomCapacity">-- kWh</strong>
            </div>
            <div class="settings-item">
                <span>SoH (zdrav√≠)</span>
                <strong id="sohValue">--%</strong>
            </div>
            <div class="settings-item">
                <span>Re√°ln√° kapacita</span>
                <strong id="realCapacity">-- kWh</strong>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">üí∞ Tarify</div>
            <div class="settings-item">
                <span>N√≠zk√Ω tarif (NT)</span>
                <strong id="ntPrice">-- Kƒç/kWh</strong>
            </div>
            <div class="settings-item">
                <span>Vysok√Ω tarif (VT)</span>
                <strong id="vtPrice">-- Kƒç/kWh</strong>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">üöó Spot≈ôeba</div>
            <div class="settings-item">
                <span>Pr≈Ømƒõrn√° spot≈ôeba</span>
                <strong id="consumption">-- kWh/100km</strong>
            </div>
            <div class="settings-item">
                <span>Dojezd na 100%</span>
                <strong id="maxRange">-- km</strong>
            </div>
        </div>
        
        <button class="main-button" onclick="loadSettings()">üîÑ Obnovit data</button>
    </div>
    
    <!-- Navigace -->
    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchScreen('calc')">‚ö°</button>
        <button class="nav-btn" onclick="switchScreen('history')">üìä</button>
        <button class="nav-btn" onclick="switchScreen('settings')">‚öôÔ∏è</button>
    </div>

    <script>
        // Konfigurace
        const CONFIG = {
            SHEET_ID: '1mNGTGD3l1H702awnQ08NfCGRLESor4bp2scm6WCLMok',
            API_KEY: localStorage.getItem('ev_api_key') || '',
            WEBAPP_URL: 'https://script.google.com/macros/s/AKfycbxY9N7alr7unEULaZ7fiMPQ77BFtXK42TVgRLWeHfhcBupNRHqyEK2_GHELQqFwp9GIag/exec'
        };
        
        // Glob√°ln√≠ data
        let settings = {};
        let selectedTariff = 'NT';
        let lastCalculation = null;
        
        // Inicializace
        window.addEventListener('load', async () => {
            if (!CONFIG.API_KEY) {
                const key = prompt('Pros√≠m zadej sv≈Øj Google Sheets API kl√≠ƒç:');
                if (key) {
                    CONFIG.API_KEY = key;
                    localStorage.setItem('ev_api_key', key);
                }
            }
            
            await loadSettings();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('currentSlider').addEventListener('input', (e) => {
                const val = e.target.value;
                document.getElementById('batteryFill').style.width = val + '%';
                document.getElementById('batteryFill').textContent = val + '%';
            });
            
            document.getElementById('kmInput').addEventListener('input', (e) => {
                if (e.target.value) {
                    const maxRange = parseFloat(settings['Dojezd na 100% (km)']) || 247;
                    const percent = Math.round((e.target.value / maxRange) * 100);
                    document.getElementById('currentSlider').value = Math.min(percent, 100);
                    document.getElementById('batteryFill').style.width = Math.min(percent, 100) + '%';
                    document.getElementById('batteryFill').textContent = Math.min(percent, 100) + '%';
                }
            });
        }
        
        async function loadSettings() {
            try {
                const range = 'Nastaven√≠!A1:B7';
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                
                settings = {};
                data.values.forEach(row => {
                    if (row[0] && row[1]) {
                        settings[row[0]] = row[1];
                    }
                });
                
                updateUI();
                showToast('‚úÖ Data naƒçtena ze Sheets');
                
            } catch (error) {
                showToast('‚ùå Chyba: ' + error.message);
            }
        }
        
        function updateUI() {
            // Aktualizuj zobrazen√≠
            const soh = parseFloat(settings['SoH - zdrav√≠ baterie (%)']) || 92.1;
            const nomCap = parseFloat(settings['Nomin√°ln√≠ kapacita (kWh)']) || 44.5;
            const realCap = (nomCap * soh / 100).toFixed(1);
            const priceNT = parseFloat(settings['Cena NT (Kƒç/kWh)']) || 0;
            const priceVT = parseFloat(settings['Cena VT (Kƒç/kWh)']) || 0;
            
            document.getElementById('sohBadge').textContent = `SoH: ${soh}%`;
            document.getElementById('priceNT').textContent = `${priceNT.toFixed(2)} Kƒç/kWh`;
            document.getElementById('priceVT').textContent = `${priceVT.toFixed(2)} Kƒç/kWh`;
            
            // Nastaven√≠
            document.getElementById('nomCapacity').textContent = `${nomCap} kWh`;
            document.getElementById('sohValue').textContent = `${soh}%`;
            document.getElementById('realCapacity').textContent = `${realCap} kWh`;
            document.getElementById('ntPrice').textContent = `${priceNT.toFixed(2)} Kƒç/kWh`;
            document.getElementById('vtPrice').textContent = `${priceVT.toFixed(2)} Kƒç/kWh`;
            document.getElementById('consumption').textContent = `${settings['Pr≈Ømƒõrn√° spot≈ôeba (kWh/100km)']} kWh/100km`;
            document.getElementById('maxRange').textContent = `${Math.round(settings['Dojezd na 100% (km)'])} km`;
        }
        
        function setTarget(percent) {
            document.getElementById('targetInput').value = percent;
        }
        
        function selectTariff(tariff) {
            selectedTariff = tariff;
            document.getElementById('tarifNT').classList.toggle('active', tariff === 'NT');
            document.getElementById('tarifVT').classList.toggle('active', tariff === 'VT');
        }
        
        function calculate() {
            const currentPercent = parseFloat(document.getElementById('currentSlider').value);
            const targetPercent = parseFloat(document.getElementById('targetInput').value);
            
            if (targetPercent <= currentPercent) {
                showToast('‚ùå C√≠lov√Ω stav mus√≠ b√Ωt vy≈°≈°√≠ ne≈æ aktu√°ln√≠!');
                return;
            }
            
            const soh = parseFloat(settings['SoH - zdrav√≠ baterie (%)']) || 92.1;
            const nomCap = parseFloat(settings['Nomin√°ln√≠ kapacita (kWh)']) || 44.5;
            const realCap = nomCap * (soh / 100);
            const consumption = parseFloat(settings['Pr≈Ømƒõrn√° spot≈ôeba (kWh/100km)']) || 18;
            const priceNT = parseFloat(settings['Cena NT (Kƒç/kWh)']) || 0;
            const priceVT = parseFloat(settings['Cena VT (Kƒç/kWh)']) || 0;
            
            const kwhNeeded = ((targetPercent - currentPercent) / 100) * realCap;
            const price = selectedTariff === 'NT' ? kwhNeeded * priceNT : kwhNeeded * priceVT;
            const rangeAfter = (targetPercent / 100) * realCap / consumption * 100;
            
            lastCalculation = {
                currentPercent,
                targetPercent,
                kwhNeeded,
                price,
                rangeAfter,
                tariff: selectedTariff,
                soh
            };
            
            document.getElementById('kwhResult').textContent = kwhNeeded.toFixed(1) + ' kWh';
            document.getElementById('priceResult').textContent = price.toFixed(2) + ' Kƒç';
            document.getElementById('rangeResult').textContent = Math.round(rangeAfter) + ' km';
            document.getElementById('results').style.display = 'block';
            document.getElementById('saveBtn').style.display = 'block';
            
            showToast('‚úÖ V√Ωpoƒçet dokonƒçen!');
        }
        
        async function saveToHistory() {
            if (!lastCalculation) return;
            
            try {
                const now = new Date();
                const data = {
                    datum: now.toLocaleDateString('cs-CZ'),
                    cas: now.toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'}),
                    zProcent: lastCalculation.currentPercent,
                    naProcent: lastCalculation.targetPercent,
                    kwh: lastCalculation.kwhNeeded.toFixed(1),
                    tarif: lastCalculation.tariff,
                    cena: lastCalculation.price.toFixed(2),
                    soh: lastCalculation.soh,
                    poznamka: ''
                };
                
                const response = await fetch(CONFIG.WEBAPP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                showToast('‚úÖ Ulo≈æeno do historie!');
                document.getElementById('saveBtn').style.display = 'none';
                
            } catch (error) {
                showToast('‚úÖ Z√°znam odesl√°n (no-cors mode)');
                document.getElementById('saveBtn').style.display = 'none';
            }
        }
        
        function switchScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`screen-${screen}`).classList.add('active');
            event.target.classList.add('active');
            
            if (screen === 'history') {
                loadHistory();
            }
        }
        
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            const loading = document.getElementById('historyLoading');
            
            loading.style.display = 'block';
            historyList.innerHTML = '';
            
            try {
                const range = 'Historie!A2:I';
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                loading.style.display = 'none';
                
                if (!data.values || data.values.length === 0) {
                    historyList.innerHTML = '<p style="text-align:center;color:#999;padding:20px">Zat√≠m ≈æ√°dn√° historie</p>';
                    return;
                }
                
                const last10 = data.values.slice(-10).reverse();
                
                last10.forEach(row => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-header">
                            <span>${row[0]} ${row[1]}</span>
                            <span style="color: #667eea">${row[5]}</span>
                        </div>
                        <div class="history-details">
                            <div>${row[2]}% ‚Üí ${row[3]}%</div>
                            <div>${
